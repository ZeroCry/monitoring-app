apiVersion: v1
kind: ConfigMap
metadata:
  name: kapacitor-alerts
  namespace: kube-system
data:
  high_cpu.tick: |
    stream
        |from()
            .measurement('cpu/node_utilization')
            .groupBy('nodename')
        |window()
            .period(5m)
            .every(5m)
        |mean('value').as('used')
        |alert()
            .message('{{ .Level}}: {{ .Name }}/{{ index .Tags "nodename" }} has high cpu usage: {{ index .Fields "used" }}%')
            .warn(lambda: "used" > 0.70)
            .crit(lambda: "used" > 0.80)
            .email()
  high_memory.tick: |
    stream
        |from()
            .measurement('memory/node_utilization')
            .groupBy('nodename')
        |window()
            .period(5m)
            .every(5m)
        |mean('value').as('used')
        |alert()
            .message('{{ .Level}}: {{ .Name }}/{{ index .Tags "nodename" }} has high memory usage: {{ index .Fields "used" }}%')
            .warn(lambda: "used" > 0.70)
            .crit(lambda: "used" > 0.80)
            .email()
  etcd_down.tick: |
    var period = 30s
    var every = 30s
    var critReset = lambda: "gauge" == 1

    var data = stream
        |from()
            .measurement('etcd_up')
            .groupBy('nodename')
        |window()
            .period(period)
            .every(every)
            .align()
        |default()
            .field('gauge', -1)

    var trigger = data
        |alert()
            .message('{{ .Level}}: ETCD instance is down: {{ index .Tags "nodename" }}')
            .crit(lambda: "gauge" == 0)
            .critReset(critReset)
            .stateChangesOnly(1h)
            .email()

    var data_etcd_health = stream
        |from()
             .measurement('etcd_health')
        |window()
             .period(period)
             .every(every)
             .align()
        |default()
             .field('gauge', -1)

    var etcd_health_deadman = data_etcd_health
        |deadman(0.0, 3m)
             .message('ETCD cluster is {{ if eq .Level "OK" }}alive{{ else }}unhealthy{{ end }}')
             .email()

    var trigger_etcd_health = data_etcd_health
        |alert()
             .message('{{ .Level}}: ETCD cluster is unhealthy')
             .crit(lambda: "gauge" == 0)
             .stateChangesOnly(30m)
             .critReset(critReset)
             .email()
